from tensorflow.keras.callbacks import ModelCheckpoint
from keras.models import Model
from keras.layers import Input, Dense, Dropout, Flatten, BatchNormalization, Activation
from keras.layers.convolutional import Conv1D, MaxPooling2D, Conv2D
from keras.layers.merge import concatenate
from keras.activations import tanh
from tensorflow.keras.optimizers import Adam
import matplotlib.pyplot as plt
from sklearn.metrics import ConfusionMatrixDisplay
from sklearn.metrics import confusion_matrix
from keras.utils.vis_utils import plot_model
from keras.callbacks import Callback
import numpy as np
import pandas as pd
from os import makedirs
from dotenv import load_dotenv
from DataGenerator import MalVecNet_Generator, get_classweight
import mlflow
from mlflow.models.signature import infer_signature
from shutil import rmtree

# Params for MLflow
load_dotenv()

Model_Name = 'MalVecNet.py'
EPOCHS = 100 #@param {type:"slider", min:0, max:1000, step:10}
LEARNING_RATE =  0.0001#@param {type:"number"}
BATCH_SIZE = 40 #@param {type:"slider", min:1, max:100, step:1}
K = 5 #@param {type:"slider", min:1, max: 8, step:1}
MAX_OPCODE_LENGHT = 64 #@param {type:"slider", min:32, max: 256, step:32}
DROPOUT = 0.3 #@param {type:"slider", min:0, max:1, step:0.1}
NUMBER_OF_INSTRUCTIONS = 3200 #@param {type:"slider", min:0, max:6400, step:200}
DATASET = "Upsampled" #@param ["raw", "YongImage","Upsampled"]

makedirs('.MalVecNet', exist_ok = True)

class_weight = get_classweight(DATASET)
train_generator = MalVecNet_Generator(BATCH_SIZE, 'train', DATASET)
val_generator = MalVecNet_Generator(BATCH_SIZE, 'val', DATASET)
test_generator = MalVecNet_Generator(BATCH_SIZE, 'test', DATASET)

mlflow.set_experiment(Model_Name)
mlflow.start_run()
mlflow.log_artifact(local_path = 'MalVecNet.py')

mlflow.log_param('dataset',DATASET)
mlflow.log_param('dropout',DROPOUT)
mlflow.log_param('class_weight',class_weight)
mlflow.log_param('epochs',EPOCHS)
mlflow.log_param('batch_size',BATCH_SIZE)
mlflow.log_param('opt_learning_rate',LEARNING_RATE)
mlflow.log_param('opt_name','adam')
mlflow.log_param('steps_per_epoch',int(train_generator.sample_size() // BATCH_SIZE))
mlflow.log_param('validation_steps',int(val_generator.sample_size() // BATCH_SIZE))
mlflow.log_param('K',K)

def CheckpointCallback():
    return ModelCheckpoint(filepath=".MalVecNet/Checkpoint",verbose=1,save_weights_only=False,save_best_only=True)

class CustomCallback(Callback):
    def on_epoch_end(self, epoch, logs=None):
        mlflow.log_metrics(logs,epoch)

def channel(input, kernel_size, name=''):
  x = Conv1D(filters=1, kernel_size=kernel_size, activation='relu', name=f"Channel_{name}Conv1D", padding="same", strides=2)(input)
  x = BatchNormalization(name=f"Channel_{name}_BatchNormalization")(x)
  x = Activation(tanh)(x)
  x = MaxPooling2D(pool_size=(2,1), name=f"Channel_{name}_MaxPooling2D")(x)
  return x

def MalVecNet_Model():
  input = Input(shape=(NUMBER_OF_INSTRUCTIONS,int(MAX_OPCODE_LENGHT/8),1))
  channel_transformer = Conv2D(filters = K, kernel_size = 4, activation='relu', name='Channel_Transformer')(input)

  channel1 = channel(input = channel_transformer, name = '1', kernel_size = 2)
  channel2 = channel(input = channel_transformer, name = '2', kernel_size = 3)
  channel3 = channel(input = channel_transformer, name = '3', kernel_size = 4)
  channel4 = channel(input = channel_transformer, name = '4', kernel_size = 5)
 
  merged = concatenate([channel1, channel2, channel3, channel4])

  maxpoollayer = MaxPooling2D(pool_size=(4,1), name='MaxPool2D_Layer')(merged)
  dropout = Dropout(DROPOUT, name='Dropout_Layer')(maxpoollayer)
  flatten = Flatten(name='Flatten_Layer')(dropout)
  dense = Dense(18, activation='relu', name="Fully_Connected_Layer")(flatten)
  output = Dense(9, activation='softmax' , name="Output_Layer")(dense)
  model = Model(inputs=input, outputs=output, name="MalVecNet")

  optimiser = Adam(learning_rate=LEARNING_RATE)
  model.compile(loss='categorical_crossentropy', optimizer=optimiser, metrics=['accuracy','Recall','Precision'])

  return model
model = MalVecNet_Model()

with open('.MalVecNet/model_summary.txt','w') as f:
    model.summary(print_fn=lambda x: f.write(x + '\n'),show_trainable=True)
mlflow.log_artifact(local_path = '.MalVecNet/model_summary.txt')
plot_model(model, show_shapes=True, to_file=f'.MalVecNet/Model_Plot.png')
mlflow.log_artifact(local_path = '.MalVecNet/Model_Plot.png')

history = model.fit(train_generator, epochs = EPOCHS, verbose = 0, validation_data = val_generator, steps_per_epoch = int(train_generator.sample_size()  // BATCH_SIZE),validation_steps = int(val_generator.sample_size() // BATCH_SIZE), callbacks = [CheckpointCallback(), CustomCallback()], class_weight=class_weight)
mlflow.log_artifact(local_path = '.MalVecNet/Checkpoint', artifact_path='')

model.load_weights('.MalVecNet/Checkpoint')
train = train_generator.__getitem__(0)[0]
predictions = model.predict(train)
mlflow.keras.log_model(model,artifact_path='model',signature=infer_signature(train, predictions), registered_model_name=Model_Name)
score = model.evaluate(test_generator,verbose=1)
mlflow.log_metrics({"test_loss": score[0], "test_accuracy": score[1], "test_recall": score[2], "test_precision": score[3]},(EPOCHS-1))
print(f'Test Loss: {score[0]}, Test Accuracy: {score[1]*100}%, Test Recall: {score[2]*100}%, Test Precision: {score[3]*100}%')

def plot_confusion_matrix(model,test_generator):
    title = Model_Name
    labels = ['Ramnit', 'Lollipop', 'Kelihos_ver3', 'Vundo', 'Simda', 'Tracur', 'Kelihos_ver1', 'Obfuscator.ACY', 'Gatak']
    pred = model.predict(test_generator)
    df = pd.DataFrame(index = np.asarray(test_generator.image_filenames).transpose())
    df['pred_label'] = np.argmax(pred, axis=1).transpose()
    df['true_label'] = np.argmax(test_generator.labels, axis=1).transpose()
    df['correct'] = df.apply(lambda row: 1 if row.pred_label == row.true_label else 0, axis=1)
    df.to_csv('.MalVecNet/predictions.csv')
    mlflow.log_artifact(local_path = '.MalVecNet/predictions.csv')
    confusion_matrix_ = confusion_matrix(np.argmax(test_generator.labels, axis=1),np.argmax(pred, axis=1),normalize='true')
    confusionMatrixDisplay = ConfusionMatrixDisplay(confusion_matrix_, display_labels=labels)
    fig, ax = plt.subplots(figsize=(20,20))
    label_font = {'size':'18'}
    plt.rcParams.update({'font.size': 14})
    ax.set_xlabel('Predicted labels', fontdict=label_font)
    ax.set_ylabel('Observed labels', fontdict=label_font)
    ax.set_title('Confusion Matrix '+title, fontdict={'size':'22'})
    ax.tick_params(axis='both', which='major', labelsize=14)
    cmD= confusionMatrixDisplay.plot(ax=ax,cmap = plt.get_cmap('Blues'), xticks_rotation='vertical')
    mlflow.log_figure(cmD.figure_, "confusion_matrix.png")

plot_confusion_matrix(model,test_generator)
mlflow.end_run()

rmtree('.MalVecNet/')